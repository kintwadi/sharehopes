// Translations data
const translations = {
  "en": {
        "hero-title": "Planting seeds of hope, together.",
        "hero-subtitle": "Sowing love, reaping change—we offer free assistance to those in need.",
        "get-involved-btn": "Get involved",
        "about-title": "About us",
        "about-content": "At ShareHopes, we believe that every act of kindness can grow into lasting change. United by compassion and a commitment to community, we provide practical support to individuals and families facing hardship. Our mission is simple, to serve with empathy, uplift with dignity, and build a shared future rooted in hope.",
        "services-title": "What we do",
        "food-title": "Food distribution",
        "food-desc": "Nutritious meals and groceries for those in need.",
        "meals-title": "Hot meals for the homeless",
        "meals-desc": "Freshly prepared food served with care.",
        "supplies-title": "School supplies",
        "supplies-desc": "Essential materials to help students thrive.",
        "hospital-title": "Hospital aid",
        "hospital-desc": "Supplying healthcare facilities with needed items.",
        "plus-title": "Plus services",
        "plus-desc": "Additional support services.",
        "contact-title": "Get involved",
        "contact-quote": "'You shall love your neighbor as yourself'",
        "phone": "+49 176 878 20948 / +244 923 701 518",
        "email": "info@shared-hope.org",
        "website": "www.shared-hope.org",
        "contact-btn": "Contact us",
        "follow-us": "Follow us",
        "copyright": "© 2025 Share Hopes",
        "get-involved-title": "Get Involved",
        "get-involved-subtitle": "Join us in making a difference",
        "volunteer-title": "Volunteer",
        "volunteer-desc": "Join our team of dedicated volunteers",
        "donate-title": "Donate",
        "donate-desc": "Support our mission with your contribution",
        "partner-title": "Partner with us",
        "partner-desc": "Collaborate with ShareHopes",
        "volunteer-btn": "Become a volunteer",
        "donate-btn": "Make a donation",
        "partner-btn": "Partner with us",
        "form-name": "Your name",
        "form-email": "Your email",
        "form-phone": "Your phone",
        "form-message": "Your message",
        "form-submit": "Send message",
        "progress-personal": "Personal Details",
        "progress-donation": "Donation",
        "progress-volunteer": "Volunteer",
        "tab-personal": "Personal Details",
        "tab-donation": "Donation",
        "tab-volunteer": "Volunteer",
        "label-firstname": "First Name *",
        "label-lastname": "Last Name *",
        "label-email": "Email Address",
        "label-phone": "Phone Number ",
        "label-address": "Address",
        "label-city": "City",
        "label-postcode": "Postcode",
        "label-country": "Country",
        "btn-previous": "Previous",
        "btn-next-donation": "Next: Donation",
        "label-donation-type": "I would like to:",
        "label-one-time": "Make a one-time donation",
        "label-monthly": "Set up a monthly donation",
        "label-donation-amount": "Donate Amount",
        "label-custom-amount": "Or enter a custom amount:",
        "label-payment-method": "Payment Method",
        "label-hear-about": "How did you hear about us?",
        "stripe-payment-link": "Donate",
        "donation-qr-caption": "Scan to donate",
        "donation-helper-text": "Click to make a donation",
        "donation-or-divider": "or",
        "volunteer-opportunities-title": "Volunteer Opportunities",
        "volunteer-interest-label": "I'm interested in volunteering:",
        "volunteer-local-label": "At local events",
        "volunteer-fundraising-label": "Fundraising activities",
        "volunteer-admin-label": "Administrative support",
        "volunteer-skills-label": "Using my professional skills",
        "availability-label": "My availability:",
        "availability-placeholder": "Select Availability",
        "availability-weekdays": "Weekdays",
        "availability-weekends": "Weekends",
        "availability-evenings": "Evenings",
        "availability-flexible": "Flexible",
        "skills-label": "Skills or experience you'd like to share:",
        "skills-placeholder": "Tell us about your skills, experience, or interests...",
        "personal-info-title": "Personal Information",
        "form-note-label": "Note:",
        "form-note-text": "Your personal information will be kept confidential and used only for the purposes of processing your donation and communicating with you about our work. You can unsubscribe from communications at any time.",
        "btn-previous-donation": "Previous: Donation",
        "submit-involvement": "Submit Your Involvement Form",
        "success-modal-title": "Thank you!",
        "success-modal-message": "Thank you for your interest in getting involved! We will be in touch soon.",
        "sending-modal-title": "Sending...",
        "sending-modal-message": "Please wait while we send your involvement form.",
        "back-home-link": "Back to Home",
        "modal-close-btn": "Close"
    },
  "de": {
        "get-involved-title": "Mitmachen",
        "get-involved-subtitle": "Machen Sie mit uns einen Unterschied",
        "volunteer-title": "Freiwillige",
        "volunteer-desc": "Werden Sie Teil unseres engagierten Freiwilligenteams",
        "donate-title": "Spenden",
        "donate-desc": "Unterstützen Sie unsere Mission mit Ihrer Spende",
        "partner-title": "Partner werden",
        "partner-desc": "Arbeiten Sie mit ShareHopes zusammen",
        "volunteer-btn": "Freiwilliger werden",
        "donate-btn": "Spenden",
        "partner-btn": "Partner werden",
        "form-name": "Ihr Name",
        "form-email": "Ihre E-Mail",
        "form-phone": "Ihre Telefonnummer",
        "form-message": "Ihre Nachricht",
        "form-submit": "Nachricht senden",
        "hero-title": "Samen der Hoffnung zusammen pflanzen.",
        "hero-subtitle": "Liebe säen, Wandel ernten – wir bieten kostenlose Hilfe für Bedürftige an.",
        "get-involved-btn": "Mitmachen",
        "about-title": "Über uns",
        "about-content": "Bei ShareHopes glauben wir, dass jede gute Tat zu nachhaltigem Wandel werden kann. Vereint durch Mitgefühl und Engagement für die Gemeinschaft, bieten wir praktische Unterstützung für Einzelpersonen und Familien, die mit Schwierigkeiten kämpfen. Unsere Mission ist einfach: mit Empathie dienen, mit Würde aufbauen und eine gemeinsame Zukunft auf der Grundlage von Hoffnung schaffen.",
        "services-title": "Was wir tun",
        "food-title": "Lebensmittelverteilung",
        "food-desc": "Nahrhafte Mahlzeiten und Lebensmittel für Bedürftige.",
        "meals-title": "Warmes Essen für Obdachlose",
        "meals-desc": "Frisch zubereitetes Essen, das mit Sorgfalt serviert wird.",
        "supplies-title": "Schulbedarf",
        "supplies-desc": "Wichtige Materialien, um Schülern zum Erfolg zu verhelfen.",
        "hospital-title": "Krankenhausunterstützung",
        "hospital-desc": "Versorgung von medizinischen Einrichtungen mit benötigten Artikeln.",
        "plus-title": "Plus-Dienstleistungen",
        "plus-desc": "Zusätzliche Unterstützungsservices.",
        "contact-title": "Mitmachen",
        "contact-quote": "'Du sollst deinen Nächsten lieben wie dich selbst'",
        "phone": "+49 176 878 20948 / +244 923 701 518",
        "email": "info@shared-hope.org",
        "website": "www.shared-hope.org",
        "contact-btn": "Kontaktieren Sie uns",
        "follow-us": "Folgen Sie uns",
        "copyright": "© 2025 Share Hopes",
        "progress-personal": "Persönliche Daten",
        "progress-donation": "Spende",
        "progress-volunteer": "Freiwilligenarbeit",
        "tab-personal": "Persönliche Daten",
        "tab-donation": "Spende",
        "tab-volunteer": "Freiwilligenarbeit",
        "label-firstname": "Vorname *",
        "label-lastname": "Nachname *",
        "label-email": "E-Mail-Adresse",
        "label-phone": "Telefonnummer",
        "label-address": "Adresse",
        "label-city": "Stadt",
        "label-postcode": "Postleitzahl",
        "label-country": "Land",
        "btn-previous": "Zurück",
        "btn-next-donation": "Weiter: Spende",
        "label-donation-type": "Ich möchte:",
        "label-one-time": "Einmalige Spende",
        "label-monthly": "Monatliche Spende",
        "label-donation-amount": "Spendehöhe",
        "label-custom-amount": "Oder geben Sie einen benutzerdefinierten Betrag ein:",
        "label-payment-method": "Zahlungsmethode",
        "label-hear-about": "Wie haben Sie von uns erfahren?",
        "stripe-payment-link": "Spenden ",
        "donation-qr-caption": "Zum Spenden scannen",
        "donation-helper-text": "Klicken Sie, um zu spenden",
        "donation-or-divider": "oder",
        "volunteer-opportunities-title": "Freiwilligenmöglichkeiten",
        "volunteer-interest-label": "Ich interessiere mich für Freiwilligenarbeit:",
        "volunteer-local-label": "Bei lokalen Veranstaltungen",
        "volunteer-fundraising-label": "Spendenaktionen",
        "volunteer-admin-label": "Administrative Unterstützung",
        "volunteer-skills-label": "Einsatz meiner beruflichen Fähigkeiten",
        "availability-label": "Meine Verfügbarkeit:",
        "availability-placeholder": "Verfügbarkeit auswählen",
        "availability-weekdays": "Wochentage",
        "availability-weekends": "Wochenenden",
        "availability-evenings": "Abende",
        "availability-flexible": "Flexibel",
        "skills-label": "Fähigkeiten oder Erfahrungen, die Sie teilen möchten:",
        "skills-placeholder": "Erzählen Sie uns von Ihren Fähigkeiten, Erfahrungen oder Interessen...",
        "personal-info-title": "Persönliche Informationen",
        "form-note-label": "Hinweis:",
        "form-note-text": "Ihre persönlichen Daten werden vertraulich behandelt und ausschließlich zur Verarbeitung Ihrer Spende und zur Kommunikation über unsere Arbeit verwendet. Sie können sich jederzeit von Mitteilungen abmelden.",
        "btn-previous-donation": "Zurück: Spende",
        "submit-involvement": "Senden Sie Ihr Beteiligungsformular",
        "success-modal-title": "Vielen Dank!",
        "success-modal-message": "Vielen Dank für Ihr Interesse, sich zu engagieren! Wir werden uns bald bei Ihnen melden.",
        "sending-modal-title": "Senden...",
        "sending-modal-message": "Bitte warten Sie, während wir Ihr Beteiligungsformular senden.",
        "back-home-link": "Zurück zur Startseite",
        "modal-close-btn": "Schließen"
    },
  "es": {
        "get-involved-title": "Involúcrate",
        "get-involved-subtitle": "Únete a nosotros para marcar la diferencia",
        "volunteer-title": "Voluntario",
        "volunteer-desc": "Únete a nuestro equipo de voluntarios dedicados",
        "donate-title": "Donar",
        "donate-desc": "Apoya nuestra misión con tu contribución",
        "partner-title": "Asóciate con nosotros",
        "partner-desc": "Colabora con ShareHopes",
        "volunteer-btn": "Convertirse en voluntario",
        "donate-btn": "Hacer una donación",
        "partner-btn": "Asociarse con nosotros",
        "form-name": "Tu nombre",
        "form-email": "Tu correo electrónico",
        "form-phone": "Tu teléfono",
        "form-message": "Tu mensage",
        "form-submit": "Enviar mensaje",
        "hero-title": "Plantando semillas de esperanza juntos.",
        "hero-subtitle": "Sembrando amor, cosechando cambio – ofrecemos ayuda gratuita a quienes lo necesitan.",
        "get-involved-btn": "Involúcrate",
        "about-title": "Sobre nosotros",
        "about-content": "En ShareHopes, creemos que cada acto de bondad puede convertirse en un cambio sostenible. Unidos por la compasión y el compromiso con la comunidad, brindamos apoyo práctico a individuos y familias que enfrentan dificultades. Nuestra misión es simple: servir con empatía, construir con dignidad y crear un futuro compartido basado en la esperanza.",
        "services-title": "Lo que hacemos",
        "food-title": "Distribución de alimentos",
        "food-desc": "Comidas nutritivas y alimentos para quienes lo necesitan.",
        "meals-title": "Comida caliente para personas sin hogar",
        "meals-desc": "Comida recién preparada servida con cuidado.",
        "supplies-title": "Suministros escolares",
        "supplies-desc": "Materiales esenciales para ayudar a los estudiantes a tener éxito.",
        "hospital-title": "Apoyo hospitalario",
        "hospital-desc": "Provisión de artículos necesarios a instalaciones médicas.",
        "plus-title": "Servicios Plus",
        "plus-desc": "Servicios de apoyo adicionales.",
        "contact-title": "Involúcrate",
        "contact-quote": "'Amarás a tu prójimo como a ti mismo'",
        "phone": "+49 176 878 20948 / +244 923 701 518",
        "email": "info@shared-hope.org",
        "website": "www.shared-hope.org",
        "contact-btn": "Contáctanos",
        "follow-us": "Síguenos",
        "copyright": "© 2025 Share Hopes",
        "progress-personal": "Detalles personales",
        "progress-donation": "Donación",
        "progress-volunteer": "Voluntariado",
        "tab-personal": "Detalles personales",
        "tab-donation": "Donación",
        "tab-volunteer": "Voluntariado",
        "label-firstname": "Nombre *",
        "label-lastname": "Apellido *",
        "label-email": "Correo electrónico",
        "label-phone": "Número de teléfono",
        "label-address": "Dirección",
        "label-city": "Ciudad",
        "label-postcode": "Código postal",
        "label-country": "País",
        "btn-previous": "Anterior",
        "btn-next-donation": "Siguiente: Donación",
        "label-donation-type": "Me gustaría:",
        "label-one-time": "Hacer una donación única",
        "label-monthly": "Configurar uma donação mensual",
        "label-donation-amount": "Montante da doação",
        "label-custom-amount": "Ou insira um montante personalizado:",
        "label-payment-method": "Método de pago",
        "label-hear-about": "¿Cómo te enteraste de nosotros?",
        "stripe-payment-link": "Donar  ",
        "donation-qr-caption": "Escanea para donar",
        "donation-helper-text": "Haga clic para hacer una donación",
        "donation-or-divider": "o",
        "volunteer-opportunities-title": "Oportunidades de voluntariado",
        "volunteer-interest-label": "Me interesa hacer voluntariado:",
        "volunteer-local-label": "En eventos locales",
        "volunteer-fundraising-label": "Actividades de recaudación de fondos",
        "volunteer-admin-label": "Apoyo administrativo",
        "volunteer-skills-label": "Usar mis habilidades profesionales",
        "availability-label": "Mi disponibilidad:",
        "availability-placeholder": "Seleccionar disponibilidad",
        "availability-weekdays": "Entre semana",
        "availability-weekends": "Fines de semana",
        "availability-evenings": "Noches",
        "availability-flexible": "Flexible",
        "skills-label": "Habilidades o experiencia que te gustaría compartir:",
        "skills-placeholder": "Cuéntanos tus habilidades, experiencia o intereses...",
        "personal-info-title": "Información personal",
        "form-note-label": "Nota:",
        "form-note-text": "Tu información personal se mantendrá confidencial y solo se utilizará para procesar tu donación y comunicarnos contigo sobre nuestro trabajo. Puedes darte de baja de las comunicaciones en cualquier momento.",
        "btn-previous-donation": "Anterior: Donación",
        "submit-involvement": "Enviar tu formulario de participación",
        "success-modal-title": "¡Gracias!",
        "success-modal-message": "¡Gracias por tu interés en involucrarte! Nos pondremos en contacto pronto.",
        "sending-modal-title": "Enviando...",
        "sending-modal-message": "Por favor, espera mientras enviamos tu formulario de participación.",
        "back-home-link": "Volver a inicio",
        "modal-close-btn": "Cerrar"
    },
  "pt": {
        "get-involved-title": "Envolva-se",
        "get-involved-subtitle": "Junte-se a nós para fazer a diferença",
        "volunteer-title": "Voluntário",
        "volunteer-desc": "Junte-se à nossa equipe de voluntários dedicados",
        "donate-title": "Doar",
        "donate-desc": "Apoie nossa missão com sua contribuição",
        "partner-title": "Parceiro conosco",
        "partner-desc": "Colabore com a ShareHopes",
        "volunteer-btn": "Tornar-se voluntário",
        "donate-btn": "Fazer uma doação",
        "partner-btn": "Parceria conosco",
        "form-name": "Seu nome",
        "form-email": "Seu email",
        "form-phone": "Seu telefone",
        "form-message": "Sua mensagem",
        "form-submit": "Enviar mensagem",
        "hero-title": "Plantando sementes de esperança, juntos.",
        "hero-subtitle": "Semeando amor, colhendo mudança—oferecemos assistência gratuita às pessoas necessitadas.",
        "get-involved-btn": "Envolva-se",
        "about-title": "Sobre nós",
        "about-content": "Na ShareHopes, acreditamos que todo ato de bondade pode crescer e se tornar uma mudança duradoura. Unidos pela compaixão e pelo compromisso com a comunidade, oferecemos apoio prático a indivíduos e famílias que enfrentam dificuldades. Nossa missão é simples: servir com empatia, elevar com dignidade e construir um futuro compartilhado enraizado na esperança.",
        "services-title": "O que fazemos",
        "food-title": "Distribuição de alimentos",
        "food-desc": "Refeições nutritivas e mantimentos para quem precisa.",
        "meals-title": "Refeições quentes para os sem-teto",
        "meals-desc": "Alimentos frescos preparados e servidos com cuidado.",
        "supplies-title": "Material escolar",
        "supplies-desc": "Materiais essenciais para ajudar os alunos a prosperar.",
        "hospital-title": "Ajuda hospitalar",
        "hospital-desc": "Fornecimento de itens necessários às instalações de saúde.",
        "plus-title": "Serviços adicionais",
        "plus-desc": "Serviços de apoio adicionais.",
        "contact-title": "Envolva-se",
        "contact-quote": "'Amarás ao teu próximo como a ti mesmo'",
        "phone": "+49 176 878 20948 / +244 923 701 518",
        "email": "info@shared-hope.org",
        "website": "www.shared-hope.org",
        "contact-btn": "Entre em contato",
        "follow-us": "Siga-nos",
        "copyright": "© 2025 Share Hopes",
        "progress-personal": "Dados pessoais",
        "progress-donation": "Doação",
        "progress-volunteer": "Voluntariado",
        "tab-personal": "Dados pessoais",
        "tab-donation": "Doação",
        "tab-volunteer": "Voluntariado",
        "label-firstname": "Primeiro nome *",
        "label-lastname": "Sobrenome *",
        "label-email": "E-mail ",
        "label-phone": "Número de telefone",
        "label-address": "Endereço",
        "label-city": "Cidade",
        "label-postcode": "CEP",
        "label-country": "País",
        "btn-previous": "Anterior",
        "btn-next-donation": "Próximo: Doação",
        "label-donation-type": "Eu gostaria:",
        "label-one-time": "Fazer uma doação única",
        "label-monthly": "Configurar uma doação mensal",
        "label-donation-amount": "Valor da doação ",
        "label-custom-amount": "Ou insira um valor personalizado:",
        "label-payment-method": "Método de pagamento",
        "label-hear-about": "Como você soube de nós?",
        "stripe-payment-link": "Doar",
        "donation-qr-caption": "Escaneie para doar",
        "donation-helper-text": "Clique para fazer uma doação",
        "donation-or-divider": "ou",
        "volunteer-opportunities-title": "Oportunidades de voluntariado",
        "volunteer-interest-label": "Tenho interesse em voluntariado:",
        "volunteer-local-label": "Em eventos locais",
        "volunteer-fundraising-label": "Atividades de arrecadação de fundos",
        "volunteer-admin-label": "Apoio administrativo",
        "volunteer-skills-label": "Usar minhas habilidades profissionais",
        "availability-label": "Minha disponibilidade:",
        "availability-placeholder": "Selecionar disponibilidade",
        "availability-weekdays": "Dias úteis",
        "availability-weekends": "Fins de semana",
        "availability-evenings": "Noites",
        "availability-flexible": "Flexível",
        "skills-label": "Habilidades ou experiência que gostaria de compartilhar:",
        "skills-placeholder": "Conte-nos sobre suas habilidades, experiência ou interesses...",
        "personal-info-title": "Informações pessoais",
        "form-note-label": "Nota:",
        "form-note-text": "Suas informações pessoais serão mantidas em sigilo e usadas apenas para processar sua doação e para nos comunicarmos com você sobre nosso trabalho. Você pode cancelar a assinatura das comunicações a qualquer momento.",
        "btn-previous-donation": "Anterior: Doação",
        "submit-involvement": "Enviar seu formulário de participação",
        "success-modal-title": "Obrigado!",
        "success-modal-message": "Obrigado pelo seu interesse em se envolver! Entraremos em contato em breve.",
        "sending-modal-title": "Enviando...",
        "sending-modal-message": "Por favor, aguarde enquanto enviamos seu formulário de participação.",
        "back-home-link": "Voltar para a página inicial",
        "modal-close-btn": "Fechar"
    }
};

// Helpers for persistence
const FLAG_MAP = {
  en: 'images/us.svg',
  de: 'images/de.svg',
  es: 'images/es.svg',
  pt: 'images/pt.svg'
};

function setCookie(name, value, days = 365) {
  const date = new Date();
  date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
  const expires = '; expires=' + date.toUTCString();
  document.cookie = `${name}=${value}${expires}; path=/; SameSite=Lax`;
}

function getCookie(name) {
  const nameEQ = name + '=';
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

function getInitialLanguage() {
  try {
    const stored = localStorage.getItem('selectedLanguage');
    if (stored && translations[stored]) return stored;
  } catch (e) {
    // localStorage might be blocked; ignore
  }
  const cookieLang = getCookie('lang');
  if (cookieLang && translations[cookieLang]) return cookieLang;
  return 'en';
}

function persistLanguage(lang) {
  try { localStorage.setItem('selectedLanguage', lang); } catch (e) {}
  setCookie('lang', lang, 365);
}

// Country list by language for get_involved page
// Country options by language. Will be dynamically populated with ALL countries.
const countryList = {
  en: [
    { value: '', label: 'Select Country', disabled: true },
    { value: 'other', label: 'Other' }
  ],
  de: [
    { value: '', label: 'Land auswählen', disabled: true },
    { value: 'other', label: 'Andere' }
  ],
  es: [
    { value: '', label: 'Seleccionar país', disabled: true },
    { value: 'other', label: 'Otro' }
  ],
  pt: [
    { value: '', label: 'Selecionar país', disabled: true },
    { value: 'other', label: 'Outro' }
  ]
};

let _countriesLoaded = false;
let _countryCodeNameMap = {}; // e.g., { 'us': 'United States' }

async function loadCountries() {
  if (_countriesLoaded) return;
  try {
    const res = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
    if (!res.ok) throw new Error('Failed to fetch countries');
    const data = await res.json();
    const countries = data
      .map(c => {
        const code = (c.cca2 || '').toLowerCase();
        const name = c.name && c.name.common ? c.name.common : '';
        return code && name ? { value: code, label: name } : null;
      })
      .filter(Boolean)
      .sort((a, b) => a.label.localeCompare(b.label));

    _countryCodeNameMap = {};
    countries.forEach(c => { _countryCodeNameMap[c.value] = c.label; });

    const placeholders = {
      en: 'Select Country',
      de: 'Land auswählen',
      es: 'Seleccionar país',
      pt: 'Selecionar país'
    };

    ['en', 'de', 'es', 'pt'].forEach(lang => {
      const placeholderObj = { value: '', label: placeholders[lang], disabled: true };
      const otherLabel = { en: 'Other', de: 'Andere', es: 'Otro', pt: 'Outro' }[lang];
      countryList[lang] = [placeholderObj, ...countries, { value: 'other', label: otherLabel }];
    });

    _countriesLoaded = true;
  } catch (err) {
    console.error('loadCountries failed; using fallback list', err);
    // Fallback to a small static set; keep current countryList content
    _countriesLoaded = true;
  }
}

async function populateCountrySelect(lang, query = '') {
  const select = document.getElementById('country');
  if (!select) return;
  await loadCountries();
  const options = countryList[lang] || countryList.en;
  const previousValue = select.value;
  // If Tom Select is active, update its options
  if (window.countryTS) {
    try {
      window.countryTS.clearOptions();
      window.countryTS.addOptions(options);
      window.countryTS.refreshOptions(false);
      if (previousValue && options.some(o => o.value === previousValue)) {
        window.countryTS.setValue(previousValue, true);
      } else {
        window.countryTS.clear(true);
      }
      return;
    } catch (e) {
      console.warn('populateCountrySelect: Tom Select update failed, falling back to native select', e);
    }
  }
  // Fallback: native select update
  select.innerHTML = '';
  const q = String(query).trim().toLowerCase();
  const filtered = q
    ? options.filter(o => (o.value === '' && o.disabled) || (o.label && o.label.toLowerCase().includes(q)))
    : options;
  filtered.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    if (opt.disabled) o.disabled = true;
    select.appendChild(o);
  });
  if (previousValue && filtered.some(o => o.value === previousValue)) {
    select.value = previousValue;
  } else {
    select.selectedIndex = 0;
  }
}

// City list by language and country for get_involved page
// City list by language and country for get_involved page
// Pre-seeded with a minimal set; will be dynamically populated with ALL cities per country.
const cityList = {
  en: {
    '': [],
    us: [
      { value: 'new-york', label: 'New York' },
      { value: 'los-angeles', label: 'Los Angeles' },
      { value: 'chicago', label: 'Chicago' },
      { value: 'houston', label: 'Houston' },
      { value: 'san-francisco', label: 'San Francisco' }
    ],
    uk: [
      { value: 'london', label: 'London' },
      { value: 'manchester', label: 'Manchester' },
      { value: 'birmingham', label: 'Birmingham' },
      { value: 'glasgow', label: 'Glasgow' },
      { value: 'liverpool', label: 'Liverpool' }
    ],
    ca: [
      { value: 'toronto', label: 'Toronto' },
      { value: 'vancouver', label: 'Vancouver' },
      { value: 'montreal', label: 'Montreal' },
      { value: 'calgary', label: 'Calgary' },
      { value: 'ottawa', label: 'Ottawa' }
    ],
    au: [
      { value: 'sydney', label: 'Sydney' },
      { value: 'melbourne', label: 'Melbourne' },
      { value: 'brisbane', label: 'Brisbane' },
      { value: 'perth', label: 'Perth' },
      { value: 'adelaide', label: 'Adelaide' }
    ],
    other: []
  },
  de: {
    '': [],
    us: [
      { value: 'new-york', label: 'New York' },
      { value: 'los-angeles', label: 'Los Angeles' },
      { value: 'chicago', label: 'Chicago' },
      { value: 'houston', label: 'Houston' },
      { value: 'san-francisco', label: 'San Francisco' }
    ],
    uk: [
      { value: 'london', label: 'London' },
      { value: 'manchester', label: 'Manchester' },
      { value: 'birmingham', label: 'Birmingham' },
      { value: 'glasgow', label: 'Glasgow' },
      { value: 'liverpool', label: 'Liverpool' }
    ],
    ca: [
      { value: 'toronto', label: 'Toronto' },
      { value: 'vancouver', label: 'Vancouver' },
      { value: 'montreal', label: 'Montreal' },
      { value: 'calgary', label: 'Calgary' },
      { value: 'ottawa', label: 'Ottawa' }
    ],
    au: [
      { value: 'sydney', label: 'Sydney' },
      { value: 'melbourne', label: 'Melbourne' },
      { value: 'brisbane', label: 'Brisbane' },
      { value: 'perth', label: 'Perth' },
      { value: 'adelaide', label: 'Adelaide' }
    ],
    other: []
  },
  es: {
    '': [],
    us: [
      { value: 'new-york', label: 'Nueva York' },
      { value: 'los-angeles', label: 'Los Ángeles' },
      { value: 'chicago', label: 'Chicago' },
      { value: 'houston', label: 'Houston' },
      { value: 'san-francisco', label: 'San Francisco' }
    ],
    uk: [
      { value: 'london', label: 'Londres' },
      { value: 'manchester', label: 'Mánchester' },
      { value: 'birmingham', label: 'Birmingham' },
      { value: 'glasgow', label: 'Glasgow' },
      { value: 'liverpool', label: 'Liverpool' }
    ],
    ca: [
      { value: 'toronto', label: 'Toronto' },
      { value: 'vancouver', label: 'Vancouver' },
      { value: 'montreal', label: 'Montreal' },
      { value: 'calgary', label: 'Calgary' },
      { value: 'ottawa', label: 'Ottawa' }
    ],
    au: [
      { value: 'sydney', label: 'Sídney' },
      { value: 'melbourne', label: 'Melbourne' },
      { value: 'brisbane', label: 'Brisbane' },
      { value: 'perth', label: 'Perth' },
      { value: 'adelaide', label: 'Adelaida' }
    ],
    other: []
  },
  pt: {
    '': [],
    us: [
      { value: 'new-york', label: 'Nova Iorque' },
      { value: 'los-angeles', label: 'Los Angeles' },
      { value: 'chicago', label: 'Chicago' },
      { value: 'houston', label: 'Houston' },
      { value: 'san-francisco', label: 'São Francisco' }
    ],
    uk: [
      { value: 'london', label: 'Londres' },
      { value: 'manchester', label: 'Manchester' },
      { value: 'birmingham', label: 'Birmingham' },
      { value: 'glasgow', label: 'Glasgow' },
      { value: 'liverpool', label: 'Liverpool' }
    ],
    ca: [
      { value: 'toronto', label: 'Toronto' },
      { value: 'vancouver', label: 'Vancouver' },
      { value: 'montreal', label: 'Montreal' },
      { value: 'calgary', label: 'Calgary' },
      { value: 'ottawa', label: 'Ottawa' }
    ],
    au: [
      { value: 'sydney', label: 'Sydney' },
      { value: 'melbourne', label: 'Melbourne' },
      { value: 'brisbane', label: 'Brisbane' },
      { value: 'perth', label: 'Perth' },
      { value: 'adelaide', label: 'Adelaide' }
    ],
    other: []
  }
};

const _cityCache = {}; // { countryCode: [ 'City1', 'City2', ... ] }

function slugify(str) {
  return String(str)
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

async function loadCitiesForCountry(countryCode) {
  if (!countryCode || countryCode === 'other') return [];
  if (_cityCache[countryCode]) return _cityCache[countryCode];
  // Map a few known special codes
  const specialMap = { uk: 'United Kingdom' };
  const countryName = specialMap[countryCode] || _countryCodeNameMap[countryCode] || '';
  if (!countryName) return [];
  try {
    const res = await fetch('https://countriesnow.space/api/v0.1/countries/cities', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ country: countryName })
    });
    if (!res.ok) throw new Error('Failed to fetch cities');
    const data = await res.json();
    const cities = Array.isArray(data?.data) ? data.data : [];
    _cityCache[countryCode] = cities;
    // Populate for all supported languages using the returned names
    ['en', 'de', 'es', 'pt'].forEach(lang => {
      cityList[lang] = cityList[lang] || {};
      cityList[lang][countryCode] = cities.map(name => ({ value: slugify(name), label: name }));
    });
    return cities;
  } catch (err) {
    console.error('loadCitiesForCountry failed; using existing cityList', err);
    return cityList.en[countryCode]?.map(c => c.label) || [];
  }
}

async function populateCitySelect(lang, query = '') {
  const citySelect = document.getElementById('city');
  const countrySelect = document.getElementById('country');
  if (!citySelect || !countrySelect) return;
  const country = countrySelect.value || '';
  let options = (cityList[lang] && cityList[lang][country]) || [];
  const previousValue = citySelect.value;
  const placeholderLabel = {
    en: 'Select City',
    de: 'Stadt auswählen',
    es: 'Seleccionar ciudad',
    pt: 'Selecionar cidade'
  }[lang] || 'Select City';
  // If Tom Select is active, update its options and placeholder
  if (window.cityTS) {
    try {
      if (!options.length && country) {
        await loadCitiesForCountry(country);
        options = (cityList[lang] && cityList[lang][country]) || [];
      }
      window.cityTS.clearOptions();
      window.cityTS.addOptions(options);
      window.cityTS.refreshOptions(false);
      // Update placeholder on the search input of Tom Select
      if (window.cityTS.control_input) {
        window.cityTS.control_input.placeholder = placeholderLabel;
      }
      if (previousValue && options.some(o => o.value === previousValue)) {
        window.cityTS.setValue(previousValue, true);
      } else {
        window.cityTS.clear(true);
      }
      return;
    } catch (e) {
      console.warn('populateCitySelect: Tom Select update failed, falling back to native select', e);
    }
  }
  // Fallback: native select update
  citySelect.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = options.length ? placeholderLabel : (country ? 'Loading cities...' : placeholderLabel);
  placeholder.disabled = true;
  placeholder.selected = true;
  citySelect.appendChild(placeholder);
  if (!options.length && country) {
    // Load cities dynamically then re-render
    try {
      await loadCitiesForCountry(country);
      options = (cityList[lang] && cityList[lang][country]) || [];
      // Rebuild options list
      citySelect.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = placeholderLabel;
      ph.disabled = true;
      ph.selected = true;
      citySelect.appendChild(ph);
      const q = String(query).trim().toLowerCase();
      const filtered = q ? options.filter(o => o.label && o.label.toLowerCase().includes(q)) : options;
      filtered.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        citySelect.appendChild(o);
      });
      if (previousValue && filtered.some(o => o.value === previousValue)) {
        citySelect.value = previousValue;
      }
      return;
    } catch (e) {
      console.error('populateCitySelect: dynamic load failed', e);
    }
  }
  const q = String(query).trim().toLowerCase();
  const filtered = q ? options.filter(o => o.label && o.label.toLowerCase().includes(q)) : options;
  filtered.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    citySelect.appendChild(o);
  });
  if (previousValue && filtered.some(o => o.value === previousValue)) {
    citySelect.value = previousValue;
  }
}

// Set language on page load from persistence
updateLanguage(getInitialLanguage());

function updateLanguage(lang) {
  const t = translations[lang];
  if (!t) return;
  for (const [key, value] of Object.entries(t)) {
    const el = document.getElementById(key);
    if (el) el.textContent = value;
  }

  // Update placeholder for Volunteer skills textarea
  const skillsTextarea = document.getElementById('skills');
  if (skillsTextarea && t['skills-placeholder']) {
    skillsTextarea.placeholder = t['skills-placeholder'];
  }

  // Note: No select element exists - using custom image-based dropdown

  // update active button styles
  document.querySelectorAll('.language-selector button').forEach(btn => {
    btn.classList.toggle('active', btn.id === `lang-${lang}`);
  });

  // Update enhanced selects if Tom Select is active, else fallback
  const countryPlaceholder = {
    en: 'Select Country',
    de: 'Land auswählen',
    es: 'Seleccionar país',
    pt: 'Selecionar país'
  }[lang] || 'Select Country';
  const cityPlaceholder = {
    en: 'Select City',
    de: 'Stadt auswählen',
    es: 'Seleccionar ciudad',
    pt: 'Selecionar cidade'
  }[lang] || 'Select City';
  if (window.countryTS) {
    // Update options
    populateCountrySelect(lang);
    // Update placeholder on Tom Select search input
    if (window.countryTS.control_input) {
      window.countryTS.control_input.placeholder = countryPlaceholder;
    }
  } else {
    populateCountrySelect(lang);
  }
  if (window.cityTS) {
    // Refresh city options for current selected country
    populateCitySelect(lang);
    if (window.cityTS.control_input) {
      window.cityTS.control_input.placeholder = cityPlaceholder;
    }
  } else {
    populateCitySelect(lang);
  }
}

// Custom image-based language selector functionality
function setupLanguageDropdown() {
  const dropdownToggle = document.querySelector('.language-dropdown-toggle');
  const dropdownMenu = document.querySelector('.language-dropdown-menu');
  const languageOptions = document.querySelectorAll('.language-option');
  
  if (!dropdownToggle || !dropdownMenu) {
    console.warn('setupLanguageDropdown: toggle or menu not found', {
      hasToggle: !!dropdownToggle,
      hasMenu: !!dropdownMenu
    });
    return;
  }
  console.log('setupLanguageDropdown: found elements', {
    optionsCount: languageOptions.length
  });

  // Function to update dropdown menu based on selected language
  function updateDropdownMenu(selectedLang) {
    // Hide all options first
    languageOptions.forEach(option => {
      option.parentElement.style.display = 'block';
    });
    
    // Hide the selected language option
    const selectedOption = dropdownMenu.querySelector(`.language-option[data-lang="${selectedLang}"]`);
    if (selectedOption) {
      selectedOption.parentElement.style.display = 'none';
    }
  }
  
  // Initialize dropdown menu and toggle flag using persisted language
  const initialLang = getInitialLanguage();
  updateDropdownMenu(initialLang);
  const currentFlag = dropdownToggle.querySelector('.flag-icon');
  if (currentFlag) {
    // Prefer using the option's actual flag image to avoid path mismatches
    const optionForLang = dropdownMenu.querySelector(`.language-option[data-lang="${initialLang}"] .flag-icon`);
    const desiredSrc = optionForLang ? optionForLang.src : FLAG_MAP[initialLang];
    const desiredAlt = optionForLang ? optionForLang.alt : initialLang;
    if (desiredSrc) {
      currentFlag.src = desiredSrc;
      currentFlag.alt = desiredAlt;
      currentFlag.setAttribute('data-lang', initialLang);
    }
  }
  
  // Toggle dropdown menu
  dropdownToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    const isExpanded = dropdownMenu.classList.contains('show');
    console.log('language-dropdown-toggle clicked; wasExpanded:', isExpanded);
    dropdownMenu.classList.toggle('show', !isExpanded);
    dropdownToggle.setAttribute('aria-expanded', !isExpanded);
    console.log('dropdownMenu show=', dropdownMenu.classList.contains('show'));
  });
  
  // Handle language selection
  languageOptions.forEach(option => {
    option.addEventListener('click', (e) => {
      e.stopPropagation();
      const lang = option.getAttribute('data-lang');
      if (lang) {
        console.log('language-option clicked', { lang });
        updateLanguage(lang);
        console.log('updateLanguage called');
        persistLanguage(lang);
        
        // Update dropdown toggle with selected language
        const flagImg = option.querySelector('.flag-icon');
        if (flagImg) {
          const currentFlag = dropdownToggle.querySelector('.flag-icon');
          if (currentFlag) {
            currentFlag.src = flagImg.src;
            currentFlag.alt = flagImg.alt;
            currentFlag.setAttribute('data-lang', lang);
            console.log('Updated toggle flag', { src: currentFlag.src, alt: currentFlag.alt });
          }
        }
        
        // Update dropdown menu to hide selected language
        updateDropdownMenu(lang);
        console.log('Dropdown menu updated to hide selected language');
        
        // Close dropdown
        dropdownMenu.classList.remove('show');
        dropdownToggle.setAttribute('aria-expanded', 'false');
        console.log('Dropdown closed');
      }
    });
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    dropdownMenu.classList.remove('show');
    dropdownToggle.setAttribute('aria-expanded', 'false');
    // console.log('Document click: dropdown closed');
  });
  
  // Prevent dropdown from closing when clicking inside
  dropdownMenu.addEventListener('click', (e) => {
    e.stopPropagation();
    // console.log('Dropdown menu inner click: stopPropagation');
  });
}

// Logo navigation: clicking the logo goes to the main page
function setupLogoNavigation() {
  const logo = document.querySelector('.logo');
  if (!logo) return;
  logo.addEventListener('click', () => {
    const currentLang = getInitialLanguage();
    // Ensure language is persisted before navigation
    persistLanguage(currentLang);
    window.location.href = 'index.html';
  });
}

// Initialize language dropdown
  document.addEventListener('DOMContentLoaded', function() {
    try {
      setupLanguageDropdown();
      console.log('setupLanguageDropdown initialized globally');
      setupLogoNavigation();
      console.log('setupLogoNavigation initialized');
      // Initialize enhanced dropdowns (use TomSelect if available, else native selects)
      (async () => {
        const lang = getInitialLanguage();
        await loadCountries();
        const countryOptions = countryList[lang] || countryList.en;
        const hasTomSelect = typeof window.TomSelect === 'function';
        const countryEl = document.querySelector('#country');
        const cityEl = document.querySelector('#city');

        // Country select
        if (hasTomSelect && countryEl) {
          window.countryTS = new TomSelect(countryEl, {
            valueField: 'value',
            labelField: 'label',
            searchField: 'label',
            options: countryOptions,
            allowEmptyOption: true,
            maxOptions: 10000,
            placeholder: {
              en: 'Select Country',
              de: 'Land auswählen',
              es: 'Seleccionar país',
              pt: 'Selecionar país'
            }[lang] || 'Select Country'
          });
        } else if (countryEl) {
          await populateCountrySelect(lang);
        }

        // City select (lazy load)
        if (hasTomSelect && cityEl) {
          window.cityTS = new TomSelect(cityEl, {
            valueField: 'value',
            labelField: 'label',
            searchField: 'label',
            options: [],
            allowEmptyOption: true,
            maxOptions: 500,
            placeholder: {
              en: 'Select City',
              de: 'Stadt auswählen',
              es: 'Seleccionar ciudad',
              pt: 'Selecionar cidade'
            }[lang] || 'Select City',
            load: async (query, callback) => {
              try {
                const currentLang = getInitialLanguage();
                const selectedCountry = window.countryTS ? window.countryTS.getValue() : (document.getElementById('country')?.value || '');
                if (!selectedCountry) return callback([]);
                await loadCitiesForCountry(selectedCountry);
                const allOptions = (cityList[currentLang] && cityList[currentLang][selectedCountry]) || [];
                const q = String(query || '').trim().toLowerCase();
                const filtered = q ? allOptions.filter(o => o.label && o.label.toLowerCase().includes(q)) : allOptions;
                callback(filtered.slice(0, 500));
              } catch (err) {
                console.error('Tom Select city load error', err);
                callback([]);
              }
            }
          });
          // React to country changes: refresh city options
          if (window.countryTS) {
            window.countryTS.on('change', async (val) => {
              const currentLang = getInitialLanguage();
              if (!val && window.cityTS) {
                window.cityTS.clearOptions();
                window.cityTS.clear(true);
                return;
              }
              await loadCitiesForCountry(val);
              const opts = (cityList[currentLang] && cityList[currentLang][val]) || [];
              if (window.cityTS) {
                window.cityTS.clearOptions();
                window.cityTS.addOptions(opts);
                window.cityTS.refreshOptions(false);
                window.cityTS.clear(true);
              }
            });
          }
        } else if (cityEl) {
          await populateCitySelect(lang);
          const ce = document.getElementById('country');
          if (ce) {
            ce.addEventListener('change', () => populateCitySelect(getInitialLanguage()));
          }
        }

        // Initial render ensures selects show options in current language
        populateCountrySelect(lang);
        populateCitySelect(lang);
      })();
    
    // Enable Donate button only when a payment method is selected
    const donateBtn = document.getElementById('donate-btn');
    const pmRadios = document.querySelectorAll('input[name="paymentMethod"]');
    if (donateBtn && pmRadios.length) {
      function refreshDonateEnabled() {
        const anySelected = Array.from(pmRadios).some(r => r.checked);
        donateBtn.disabled = !anySelected;
      }
      pmRadios.forEach(r => r.addEventListener('change', refreshDonateEnabled));
      // Initial state
      refreshDonateEnabled();
    }
  } catch (err) {
    console.error('Failed to initialize language dropdown', err);
  }
});


